<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards</title>
    <style>
        .hidden {
            display: none;
        }
        #flash-card-container {
            cursor: pointer;
        }
        ol > li {
            cursor: pointer;
            padding: 10px;
        }
        ol {
            display: flex;
        }
        .active {
            font-weight: 700;
        }
    </style>
</head>

<body>
    <h1>hello world12</h1>
    <div id="categories"></div>
    <p>Jump to question:</p>
    <div id="question-links"></div>
    <div id="flash-card-container">
        <p id="flash-card-question"></p>
        <p id="flash-card-answer"></p>
    </div>
    <div>
        <button id="previous-flash-card">previous</button>
        <button id="next-flash-card">next</button>
    </div>
    <script type="text/javascript">
        var cardStore = {}
        var currentQuestionNumber = 0

        const getLocationHash = () => {
            const hash = window.location.hash
            const queryIndex = hash.indexOf('?')
            if (queryIndex < 0) {
                return hash.slice(1)
            } else {
                return hash.slice(1, queryIndex)
            }
        }
        const renderFlashcards = (markdown) => {
            // all lines that start with #
            const questionRegex = /#+.*/gm
            // all lines that are between lines that start with #
            const answerRegex = /(?<=#+.*\n)((.|\n)*?)(?=(#|^$))/gm
            const questions = markdown.match(questionRegex)
            const answers = markdown.match(answerRegex)
            if (questions.length !== answers.length) {
                console.error('Questions and answers length does not match!')
            }
            const total = questions.length
            return { questions, answers, total }
        }

        const fetchJson = async (url) => {
            let res = await fetch(url)
            const data = await res.json()
            return data
        }

        const fetchText = async (url) => {
            let res = await fetch(url)
            const text = await res.text()
            return text
        }
        const loadFlashCardDownloadLinks = async () => {
            const links = await fetchJson('https://api.github.com/repos/reidjs/flashcards/contents/categories')
            return links
        }
        const getDownloadUrl = (name, links) => {
            if(links.length == 0) return 
            for(let i = 0; i < links.length; i++) {
                if (links[i].name == name) {
                    return links[i].download_url
                }
            }
        }

        const getCardStack = () => {
            const hash = getLocationHash()
            return cardStore[hash]
        }

        const populateStore = async (link) => {
            const url = link.download_url
            const rawMarkdown = await fetchText(url)
            const { questions, answers, total } = renderFlashcards(rawMarkdown)
            cardStore[link.name] = { questions, answers, total }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const links = await loadFlashCardDownloadLinks()
            const categories = document.getElementById('categories')
            const questionLinks = document.getElementById('question-links')
            const flashCardContainer = document.getElementById('flash-card-container')
            const flashCardQuestion = document.getElementById('flash-card-question')
            const flashCardAnswer = document.getElementById('flash-card-answer')
            const nextCardButton = document.getElementById('next-flash-card')
            const previousCardButton = document.getElementById('previous-flash-card')

            function flipCard() {
                flashCardQuestion.classList.toggle('hidden')
                flashCardAnswer.classList.toggle('hidden')
            }

            flashCardContainer.addEventListener('click', flipCard)

            const changeCard = dir => {
                const newCard = currentQuestionNumber + dir
                flashCardQuestion.classList.remove('hidden')
                flashCardAnswer.classList.add('hidden')
                setCard(newCard)
            }

            const initDeck = () => {
                currentQuestionNumber = 0
                flashCardAnswer.classList.add('hidden')
                const questions = getCardStack().questions.length
                const ol = document.createElement('ol')

                for(let i = 0; i < questions; i++) {
                    const li = document.createElement('li')                    
                    li.addEventListener('click', () => setCard(i))
                    ol.appendChild(li)
                    questionLinks.innerHTML = ''
                    questionLinks.appendChild(ol)
                }

                setCard(0)
            }

            const updateQuestionLinksActiveNumber = (n) => {
                console.log(questionLinks.childNodes)
                if (questionLinks.childNodes.length == 0) return
                const ol = questionLinks.childNodes[0]
                console.log(ol)
                for(let i = 0; i < ol.childNodes.length; i++) {
                    if (i !== n) {
                        ol.childNodes[i].classList.remove('active')
                    } else {
                        ol.childNodes[i].classList.add('active')
                    }
                }
            }

            const setCard = (n) => {
                const s = getCardStack()
                flashCardQuestion.innerHTML = s.questions[n]
                flashCardAnswer.innerHTML = s.answers[n]
                currentQuestionNumber = n
                updateQuestionLinksActiveNumber(n)
            }   

            nextCardButton.addEventListener('click', () => changeCard(1))
            previousCardButton.addEventListener('click', () => changeCard(-1))

            for(let i = 0; i < links.length; i++) {
                const link = links[i]
                const li = document.createElement('li')
                const a = document.createElement('a')
                a.innerHTML = link.name
                a.href = `#${link.name}`
                li.appendChild(a)
                categories.appendChild(li)
                await populateStore(links[i])
            }

            window.onhashchange = (e) => {
                initDeck(0)
            }

            if (window.location.hash) {
                initDeck(0)
            }
        })
    </script>
</body>
</html>