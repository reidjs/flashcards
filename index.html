<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .hidden {
            display: none;
        }
        #flash-card-text {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>hello world12</h1>
    <div id="categories"></div>
    <div id="flash-card-container">
        <h1 id="flash-card-title"></h1>
        <p id="flash-card-text"></p>
        <p id="flash-card-question">
        </p>
        <p id="flash-card-answer"></p>
    </div>
    <div>
        <button id="previous-flash-card">previous</button>
        <button id="next-flash-card">next</button>
    </div>
    <script type="text/javascript">
        var isDev = window.location.hostname === 'localhost' ? true : false
        var categoryNames = []

        const getLocationHash = () => {
            const hash = window.location.hash
            const queryIndex = hash.indexOf('?')
            console.log(queryIndex)
            if (queryIndex < 0) {
                return hash.slice(1)
            } else {
                return hash.slice(1, queryIndex)
            }
        }
        const renderFlashcards = (markdown) => {
            console.log(markdown)
            // all lines that start with #
            const questionRegex = /#+.*/gm
            // all lines that are between lines that start with #
            const answerRegex = /(?<=#+.*\n)((.|\n)*?)(?=(#|^$))/gm
            const questions = markdown.match(questionRegex)
            const answers = markdown.match(answerRegex)
            console.log('q', questions)
            console.log('a', answers)
            if (questions.length !== answers.length) {
                console.error('Questions and answers length does not match!')
            }
            const total = questions.length
            return { questions, answers, total }
        }
        const fetchJson = async (url) => {
            let res = await fetch(url)
            await res.json()
        }
        const getNewQueryString = (key, value, url) => {
            if (!url) url = window.location.href;
            console.log(key, value)
            var re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
                hash;

            if (re.test(url)) {
                if (typeof value !== 'undefined' && value !== null) {
                    return url.replace(re, '$1' + key + "=" + value + '$2$3');
                } 
                else {
                    hash = url.split('#');
                    url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
                    if (typeof hash[1] !== 'undefined' && hash[1] !== null) {
                        url += '#' + hash[1];
                    }
                    return url;
                }
            }
            else {
                if (typeof value !== 'undefined' && value !== null) {
                    var separator = url.indexOf('?') !== -1 ? '&' : '?';
                    hash = url.split('#');
                    url = hash[0] + separator + key + '=' + value;
                    if (typeof hash[1] !== 'undefined' && hash[1] !== null) {
                        url += '#' + hash[1];
                    }
                    return url;
                }
                else {
                    return url;
                }
            }
        }
        const UpdateQueryString = (key, value, url) => {
            window.location.href = getNewQueryString(key, value, url)
        }
        const fetchText = async (url) => {
            let res = await fetch(url)
            const text = await res.text()
            return text
        }
        const loadFlashCardDownloadLinks = async () => {
            let links = [
                {
                    "name": "capitals.md",
                    "download_url": "https://raw.githubusercontent.com/reidjs/flashcards/master/categories/capitals.md",
                },
                {
                    "name": "programming.md",
                    "download_url": "https://raw.githubusercontent.com/reidjs/flashcards/master/categories/programming.md",
                }
            ]
            if (!isDev) {
                links = await fetchJson('https://api.github.com/repos/reidjs/flashcards/contents/categories')
                console.log('using real links:', links)
            }
            return links
        }
        const getDownloadUrl = (name, links) => {
            if(links.length == 0) return 
            for(let i = 0; i < links.length; i++) {
                if (links[i].name == name) {
                    return links[i].download_url
                }
            }
        }
        const getQuery = () => {
            // const queryIndex = window.location..indexOf('?')
            // let query = ''
            // if (queryIndex >= 0) {
            const query = Object.fromEntries(new URLSearchParams(window.location.search));
            // }

            return query
        }
        const changeCard = (dir) => {
            const q = getQuery()
            let num = 0
            if (q.a) num = q.a
            if (q.q) num = q.q
            const nextNum = num + dir
            // if (nextNum < /0)
            // TODO: make sure nextNum is not outside range
            UpdateQueryString('a', '')
            UpdateQueryString('q', nextNum)
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const links = await loadFlashCardDownloadLinks()
            const categories = document.getElementById('categories')
            const flashCardTitle = document.getElementById('flash-card-title')
            const flashCardContainer = document.getElementById('flash-card-container')
            const flashCardQuestion = document.getElementById('flash-card-question')
            const flashCardAnswer = document.getElementById('flash-card-answer')
            const nextCardButton = document.getElementById('next-flash-card')
            const previousCardButton = document.getElementById('previous-flash-card')
            function flipCard() {
                console.log(flashCardAnswer)
                flashCardQuestion.classList.toggle('hidden')
                flashCardAnswer.classList.toggle('hidden')
            }
            flashCardContainer.addEventListener('click', flipCard)

            // nextCardButton.addEventListener('click', changeCard(1))
            // previousCardButton.addEventListener('click', changeCard(-1))
            for(let i = 0; i < links.length; i++) {
                const link = links[i]
                const li = document.createElement('li')
                const a = document.createElement('a')
                a.innerHTML = link.name
                a.href = `#${link.name}`
                li.appendChild(a)
                categories.appendChild(li)
            }
            const showCategories = () => {
                categories.classList.remove('hidden')
            }
            const hideCategories = () => {
                categories.classList.add('hidden')
            }

            window.onhashchange = async (e) => {
                const hash = getLocationHash()
                console.log('hash', hash)

                if (hash.length < 1) {
                    showCategories()
                    return
                } else {
                    // hideCategories()
                }
                const url = getDownloadUrl(getLocationHash(), links)
                const rawMarkdown = await fetchText(url)
                // console.log(rawText)
                const { questions, answers, total } = renderFlashcards(rawMarkdown)
                // let visibleCard = 0
                // add all cards with the 'hidden' class
                // make the visibleCard 
                // const queryIndex = window.location.hash.indexOf('?')
                // let query = ''
                // if (queryIndex >= 0) {
                //     query = Object.fromEntries(new URLSearchParams(window.location.hash.slice(queryIndex)));
                // }
                const query = getQuery()
                // https://stackoverflow.com/questions/8648892/how-to-convert-url-parameters-to-a-javascript-object
                // const query = Object.fromEntries(new URLSearchParams(window.location.hash.slice()));
                console.log('query ', query)
                // q=1 means show question 1
                // a=1 means show answer 1
                // not showing question or answer, show first question
                // if (!query.q && !query.a) {
                //     updateQueryString('q', 0)
                // }
                // TODO: optimize
                // removes all children from #flashcards
                // adds the relevant 
                // let cardText
                // flashCardTitle.innerHTML = 'Question'
                const num = query.num || 0
                flashCardQuestion.innerHTML = questions[num]
                flashCardAnswer.innerHTML = answers[num]
                flashCardAnswer.classList.add('hidden')
                // if (typeof query.q != undefined) {
                //     cardText = questions[query.q]
                // } else if (typeof query.a != undefined) {
                //     flashCardTitle.innerHTML = 'Answer'
                //     cardText = answers[query.a]
                // } else {
                //     cardText = questions[0]
                // }
                // flashCardText.innerHTML = cardText
                // console.log(cardText)
                
            }
            // window.addEventListener('popstate', listener);
            // showCategories()
        })
    </script>
</body>
</html>